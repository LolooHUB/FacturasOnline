<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Facturaci칩n Digital</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; --card: #ffffff; --border: #e2e8f0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 10px; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h3 { font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin: 0 0 15px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 1rem; margin-bottom: 10px; background: #fff; color: #000; }
        
        .grid-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; font-size: 0.9rem; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-mail { background: var(--primary); color: white; }
        .btn-wa { background: #22c55e; color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* PREVIEW FACTURA */
        #factura-preview { background: white; color: black; border: 2px solid #000; padding: 15px; font-size: 0.8rem; margin-top: 10px; }
        .f-top { display: flex; border: 1px solid #000; margin-bottom: 10px; }
        .f-col { flex: 1; padding: 10px; }
        .f-letra { width: 50px; border-left: 1px solid #000; border-right: 1px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #eee; }
        .f-letra b { font-size: 2rem; }
        .f-letra span { font-size: 0.6rem; font-weight: bold; }
        .f-line { border: 1px solid #000; padding: 10px; border-top: none; }
        .f-total { border: 1px solid #000; border-top: none; padding: 10px; text-align: right; font-size: 1.4rem; font-weight: bold; }

        @media (max-width: 600px) {
            .f-top { flex-direction: column; }
            .f-letra { width: 100%; border: 1px solid #000; border-left: none; border-right: none; height: 50px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h3>游끽 Mis Datos (Emisor)</h3>
        <input type="text" id="eNom" placeholder="Nombre de tu Negocio/Empresa" oninput="upd()">
        <input type="text" id="eCuit" placeholder="Tu CUIT" oninput="upd()">
        <input type="text" id="ePago" placeholder="Alias, CBU o Link de Pago">
    </div>

    <div class="card">
        <h3>游녻 Cliente y Comprobante</h3>
        <div style="display: flex; gap: 10px;">
            <select id="tipoF" onchange="upd()">
                <option value="C">Factura C</option>
                <option value="A">Factura A</option>
                <option value="B">Factura B</option>
            </select>
            <input type="text" id="fec" placeholder="Fecha" oninput="upd()">
        </div>
        <input type="text" id="cNom" placeholder="Nombre del Cliente" oninput="upd()">
        <textarea id="det" placeholder="Detalle de los servicios o productos..." oninput="upd()"></textarea>
        <input type="number" id="monto" placeholder="Monto Total $" oninput="upd()">
        
        <input type="email" id="email" placeholder="Email del cliente">
        <input type="tel" id="tel" placeholder="WhatsApp del cliente (Ej: 54911...)">
        
        <div class="grid-btns">
            <button onclick="enviar('mail')" class="btn btn-mail" id="btnM">游닎 Enviar por Mail</button>
            <button onclick="enviar('wa')" class="btn btn-wa">游릭 Enviar WhatsApp</button>
        </div>
    </div>

    <h3>Vista Previa:</h3>
    <div id="factura-preview">
        <div class="f-top">
            <div class="f-col"><strong id="p-eNom">EMPRESA</strong><br>CUIT: <span id="p-eCuit">00-00000000-0</span></div>
            <div class="f-letra"><b id="p-letra">C</b><span id="p-cod">COD. 011</span></div>
            <div class="f-col" style="text-align: right;"><strong>FACTURA</strong><br>Fecha: <span id="p-fec">--/--/--</span></div>
        </div>
        <div class="f-line"><strong>Cliente:</strong> <span id="p-cNom">...</span></div>
        <div class="f-line" style="min-height: 60px;"><strong>Detalle:</strong><br><span id="p-det">...</span></div>
        <div class="f-total">TOTAL: <span id="p-tot">$ 0.00</span></div>
    </div>
</div>

<script>
    // Inicializaci칩n de EmailJS
    emailjs.init("ne2_1nbxGq2hC0ju1");

    // Fecha actual por defecto
    document.getElementById('fec').value = new Date().toLocaleDateString();

    function upd() {
        const letra = document.getElementById('tipoF').value;
        document.getElementById('p-eNom').innerText = document.getElementById('eNom').value.toUpperCase() || "MI EMPRESA";
        document.getElementById('p-eCuit').innerText = document.getElementById('eCuit').value || "00-00000000-0";
        document.getElementById('p-cNom').innerText = document.getElementById('cNom').value.toUpperCase() || "...";
        document.getElementById('p-det').innerText = document.getElementById('det').value || "...";
        document.getElementById('p-tot').innerText = "$ " + (document.getElementById('monto').value || "0.00");
        document.getElementById('p-fec').innerText = document.getElementById('fec').value;
        document.getElementById('p-letra').innerText = letra;
        
        // C칩digos AFIP r치pidos
        const cods = {"A": "COD. 001", "B": "COD. 006", "C": "COD. 011"};
        document.getElementById('p-cod').innerText = cods[letra];
    }

    async function enviar(canal) {
        const emisor = document.getElementById('eNom').value || "Emisor";
        const cliente = document.getElementById('cNom').value || "Cliente";
        const monto = document.getElementById('monto').value || "0";
        const concepto = document.getElementById('det').value || "-";
        const pago = document.getElementById('ePago').value || "No especificado";
        const letra = document.getElementById('tipoF').value;
        const fecha = document.getElementById('fec').value;

        // GENERAR PDF PARA DESCARGA (Respaldo)
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        pdf.setFontSize(20); pdf.text(`FACTURA ${letra}`, 105, 20, {align:'center'});
        pdf.setFontSize(10);
        pdf.text(`Emisor: ${emisor}`, 20, 40);
        pdf.text(`Fecha: ${fecha}`, 150, 40);
        pdf.text("--------------------------------------------------", 20, 50);
        pdf.text(`Cliente: ${cliente}`, 20, 60);
        pdf.text(`Concepto: ${concepto}`, 20, 75);
        pdf.setFontSize(14);
        pdf.text(`TOTAL: $${monto}`, 20, 100);
        pdf.save(`Factura_${cliente}.pdf`);

        if (canal === 'mail') {
            const mailDestino = document.getElementById('email').value;
            if(!mailDestino) return alert("Ingres치 el email del cliente");
            
            const btn = document.getElementById('btnM');
            btn.innerText = "Enviando...";
            btn.disabled = true;

            // Env칤o de Variables a la plantilla HTML de EmailJS
            emailjs.send("service_t5t4wor", "template_vyjg8af", {
                to_email: mailDestino,
                to_name: cliente,
                emisor_name: emisor,
                total_monto: monto,
                detalle_venta: concepto,
                pago_alias: pago,
                letra_factura: letra,
                fecha_comprobante: fecha
            }).then(() => {
                alert("춰Mail enviado con formato factura!");
            }).catch((err) => {
                alert("Error al enviar");
                console.error(err);
            }).finally(() => {
                btn.innerText = "游닎 Enviar por Mail";
                btn.disabled = false;
            });

        } else {
            const tel = document.getElementById('tel').value;
            if(!tel) return alert("Ingres치 el WhatsApp");
            const txt = `*FACTURA ${letra}*%0A` +
                        `*De:* ${emisor}%0A` +
                        `*Cliente:* ${cliente}%0A` +
                        `*Detalle:* ${concepto}%0A` +
                        `*TOTAL:* $${monto}%0A` +
                        `*Pago:* ${pago}%0A%0A` +
                        `_El PDF se descarg칩 autom치ticamente._`;
            window.open(`https://api.whatsapp.com/send?phone=${tel}&text=${txt}`, '_blank');
        }
    }
    window.onload = upd;
</script>
</body>
</html>

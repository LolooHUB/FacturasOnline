<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturador Pro - Versi贸n Final</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; --card: #ffffff; --border: #e2e8f0; }
        body.dark-mode { --bg: #0f172a; --text: #f1f5f9; --card: #1e293b; --border: #334155; }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; transition: 0.3s; }
        .app-container { max-width: 1000px; margin: 0 auto; }
        
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        h3 { font-size: 0.8rem; text-transform: uppercase; color: #64748b; margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 15px; }
        label { display: block; font-size: 0.75rem; font-weight: 700; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 0.9rem; background: var(--card); color: var(--text); margin-bottom: 10px; }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn { padding: 15px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; font-size: 0.9rem; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-theme { position: fixed; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); cursor: pointer; color: var(--text); }

        /* PREVIEW FACTURA (OCULTA POR DEFECTO O AL FINAL) */
        .preview-container { margin-top: 30px; display: flex; justify-content: center; overflow-x: auto; padding-bottom: 50px; }
        #factura-papel { 
            background: white; color: black; width: 210mm; min-height: 250mm; padding: 15mm; 
            box-sizing: border-box; border: 1px solid #000; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        /* Estilo AFIP */
        .f-header { display: flex; border: 1px solid #000; height: 110px; }
        .f-col { flex: 1; padding: 10px; font-size: 0.85rem; }
        .f-letra { width: 60px; border-left: 1px solid #000; border-right: 1px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #eee; }
        .f-cliente { border: 1px solid #000; border-top: none; padding: 10px; font-size: 0.85rem; line-height: 1.5; }
        .f-items-h { display: grid; grid-template-columns: 3fr 1fr; background: #eee; border: 1px solid #000; border-top: none; padding: 5px 10px; font-weight: bold; }
        .f-items-b { border: 1px solid #000; border-top: none; min-height: 300px; display: grid; grid-template-columns: 3fr 1fr; }
        .f-items-b div { padding: 10px; border-right: 1px solid #000; }
        .f-total { border: 1px solid #000; border-top: none; padding: 10px; text-align: right; font-size: 1.5rem; font-weight: bold; }
    </style>
</head>
<body>

<button class="btn-theme" onclick="document.body.classList.toggle('dark-mode')"></button>

<div class="app-container">
    <div class="main-grid">
        <div class="card">
            <h3> Mis Datos</h3>
            <label>Nombre Empresa</label>
            <input type="text" id="eNom" value="Aero 2000" oninput="render()">
            <label>Mi CUIT</label>
            <input type="text" id="eCuit" value="30-12345678-9" oninput="render()">
            <label>Tipo</label>
            <select id="tFac" onchange="render()">
                <option value="C">FACTURA C</option>
                <option value="B">FACTURA B</option>
                <option value="A">FACTURA A</option>
            </select>
        </div>

        <div class="card">
            <h3> Datos Cliente</h3>
            <label>Nombre / Raz贸n Social</label>
            <input type="text" id="cNom" oninput="render()">
            <div class="row">
                <div>
                    <label>CUIT / DNI</label>
                    <input type="text" id="cId" oninput="render()">
                </div>
                <div>
                    <label>IVA</label>
                    <select id="cIva" onchange="render()">
                        <option>Consumidor Final</option>
                        <option>Resp. Inscripto</option>
                        <option>Monotributista</option>
                    </select>
                </div>
            </div>
            <label>Direcci贸n</label>
            <input type="text" id="cDir" oninput="render()">
        </div>
    </div>

    <div class="main-grid">
        <div class="card">
            <h3> Venta</h3>
            <label>Concepto</label>
            <textarea id="det" oninput="render()" style="height: 60px;"></textarea>
            <div class="row">
                <div>
                    <label>Monto Total</label>
                    <input type="number" id="monto" oninput="render()">
                </div>
                <div>
                    <label>Fecha</label>
                    <input type="date" id="fec" onchange="render()">
                </div>
            </div>
        </div>

        <div class="card">
            <h3> Finalizar</h3>
            <label>Email del Cliente</label>
            <input type="email" id="email" placeholder="mail@ejemplo.com">
            <label>WhatsApp (con 549)</label>
            <input type="tel" id="tel" placeholder="54911...">
            
            <div class="btn-group">
                <button onclick="generar('mail')" class="btn btn-primary" id="btnMail"> Enviar Mail</button>
                <button onclick="generar('wa')" class="btn btn-whatsapp" id="btnWa"> WhatsApp</button>
            </div>
        </div>
    </div>

    <div class="preview-container">
        <div id="factura-papel">
            <div class="f-header">
                <div class="f-col">
                    <strong id="p-eNom">AERO 2000</strong><br>
                    <span>CUIT: <span id="p-eCuit">...</span></span><br>
                    <span>Cond. IVA: Monotributo</span>
                </div>
                <div class="f-letra">
                    <h1 id="p-letra" style="margin:0">C</h1>
                    <small>COD. 011</small>
                </div>
                <div class="f-col" style="text-align: right;">
                    <strong>FACTURA</strong><br>
                    <span>Fecha: <span id="p-fec">--/--/--</span></span><br>
                    <span>Nro: 0001-00000001</span>
                </div>
            </div>
            <div class="f-cliente">
                <strong>Cliente:</strong> <span id="p-cNom">...</span><br>
                <strong>CUIT/DNI:</strong> <span id="p-cId">...</span> | <strong>IVA:</strong> <span id="p-cIva">...</span><br>
                <strong>Domicilio:</strong> <span id="p-cDir">...</span>
            </div>
            <div class="f-items-h"><span>Descripci贸n</span><span style="text-align:right">Subtotal</span></div>
            <div class="f-items-b">
                <div id="p-det">...</div>
                <div id="p-sub" style="text-align:right; font-weight:bold;">$ 0.00</div>
            </div>
            <div class="f-total">TOTAL: <span id="p-tot">$ 0.00</span></div>
        </div>
    </div>
</div>

<script>
    emailjs.init("ne2_1nbxGq2hC0ju1");

    function render() {
        document.getElementById('p-eNom').innerText = document.getElementById('eNom').value.toUpperCase();
        document.getElementById('p-eCuit').innerText = document.getElementById('eCuit').value;
        document.getElementById('p-letra').innerText = document.getElementById('tFac').value;
        document.getElementById('p-cNom').innerText = document.getElementById('cNom').value.toUpperCase() || "...";
        document.getElementById('p-cId').innerText = document.getElementById('cId').value || "...";
        document.getElementById('p-cIva').innerText = document.getElementById('cIva').value;
        document.getElementById('p-cDir').innerText = document.getElementById('cDir').value || "...";
        document.getElementById('p-det').innerText = document.getElementById('det').value || "...";
        const val = document.getElementById('monto').value || "0.00";
        document.getElementById('p-tot').innerText = "$ " + val;
        document.getElementById('p-sub').innerText = "$ " + val;
        const f = document.getElementById('fec').value;
        document.getElementById('p-fec').innerText = f ? f.split('-').reverse().join('/') : new Date().toLocaleDateString();
    }

    async function generar(canal) {
        const element = document.getElementById('factura-papel');
        const mail = document.getElementById('email').value;
        const tel = document.getElementById('tel').value;

        try {
            const canvas = await html2canvas(element, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            
            // Siempre descarga el PDF
            pdf.save(`Factura_${document.getElementById('cNom').value || 'Venta'}.pdf`);

            if (canal === 'mail' && mail) {
                const base64 = pdf.output('datauristring').split(',')[1];
                await emailjs.send("service_t5t4wor", "template_vyjg8af", {
                    to_email: mail,
                    content: base64,
                    to_name: document.getElementById('cNom').value
                });
                alert("隆PDF enviado por mail!");
            } else if (canal === 'wa' && tel) {
                const msg = window.encodeURIComponent(`Hola ${document.getElementById('cNom').value}, te env铆o la factura. El PDF se acaba de descargar en tu equipo.`);
                window.open(`https://api.whatsapp.com/send?phone=${tel}&text=${msg}`, '_blank');
            }
        } catch (e) { alert("Error: " + e.message); }
    }
    window.onload = render;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturador Pro v3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; --card: #ffffff; --border: #e2e8f0; }
        body.dark-mode { --bg: #0f172a; --text: #f1f5f9; --card: #1e293b; --border: #334155; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; transition: 0.3s; }
        .app-container { max-width: 900px; margin: 0 auto; }
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { font-size: 0.8rem; text-transform: uppercase; color: #64748b; margin: 0 0 15px 0; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 0.9rem; background: var(--card); color: var(--text); margin-bottom: 10px; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 14px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; font-size: 0.85rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-whatsapp { background: #25d366; color: white; }
        .btn-theme { position: fixed; top: 15px; right: 15px; width: 35px; height: 35px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); cursor: pointer; z-index: 100; }
        
        /* PREVIEW RESPONSIVE */
        .preview-area { margin-top: 20px; display: flex; justify-content: center; }
        #factura-papel { 
            background: white; color: black; width: 100%; max-width: 600px; 
            padding: 20px; border: 1px solid #000; font-size: 0.8rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .f-header { display: flex; border: 1px solid #000; margin-bottom: 10px; }
        .f-col { flex: 1; padding: 10px; }
        .f-letra { width: 50px; border-left: 1px solid #000; border-right: 1px solid #000; display: flex; align-items: center; justify-content: center; background: #eee; font-weight: bold; font-size: 1.5rem; }
        .f-total { border: 1px solid #000; padding: 10px; text-align: right; font-size: 1.2rem; font-weight: bold; margin-top: 10px; }
        
        @media (max-width: 600px) {
            .f-header { flex-direction: column; }
            .f-letra { width: 100%; border: none; border-top: 1px solid #000; border-bottom: 1px solid #000; }
        }
    </style>
</head>
<body>

<button class="btn-theme" onclick="document.body.classList.toggle('dark-mode')">üåì</button>

<div class="app-container">
    <div class="main-grid">
        <div class="card">
            <h3>üè¢ Mis Datos</h3>
            <input type="text" id="eNom" value="Aero 2000" oninput="render()">
            <input type="text" id="eCuit" value="30-12345678-9" oninput="render()">
            <input type="text" id="ePago" value="ALIAS.PAGO.MP" placeholder="Alias o CBU">
        </div>
        <div class="card">
            <h3>üë§ Cliente</h3>
            <input type="text" id="cNom" placeholder="Nombre Cliente" oninput="render()">
            <input type="text" id="cId" placeholder="CUIT / DNI" oninput="render()">
            <input type="email" id="email" placeholder="email@cliente.com">
            <input type="tel" id="tel" placeholder="WhatsApp (549...)">
        </div>
    </div>

    <div class="card">
        <h3>üì¶ Venta</h3>
        <textarea id="det" placeholder="Concepto..." oninput="render()"></textarea>
        <div class="btn-group">
            <input type="number" id="monto" placeholder="Monto $" oninput="render()">
            <div class="btn-group">
                <button onclick="enviar('mail')" class="btn btn-primary" id="btnM">üìß Mail</button>
                <button onclick="enviar('wa')" class="btn btn-whatsapp">üü¢ WhatsApp</button>
            </div>
        </div>
    </div>

    <div class="preview-area">
        <div id="factura-papel">
            <div class="f-header">
                <div class="f-col"><strong id="p-eNom">AERO 2000</strong><br>CUIT: <span id="p-eCuit">...</span></div>
                <div class="f-letra">C</div>
                <div class="f-col" style="text-align: right;"><strong>FACTURA</strong><br><span id="p-fec"></span></div>
            </div>
            <div style="padding:10px; border:1px solid #000; border-top:none">
                <strong>Cliente:</strong> <span id="p-cNom">...</span><br>
                <strong>DNI/CUIT:</strong> <span id="p-cId">...</span>
            </div>
            <div style="padding:10px; border:1px solid #000; border-top:none; min-height:100px">
                <strong>Detalle:</strong><br><span id="p-det">...</span>
            </div>
            <div class="f-total">TOTAL: <span id="p-tot">$ 0.00</span></div>
        </div>
    </div>
</div>

<script>
    emailjs.init("ne2_1nbxGq2hC0ju1");

    function render() {
        document.getElementById('p-eNom').innerText = document.getElementById('eNom').value.toUpperCase();
        document.getElementById('p-eCuit').innerText = document.getElementById('eCuit').value;
        document.getElementById('p-cNom').innerText = document.getElementById('cNom').value.toUpperCase() || "...";
        document.getElementById('p-cId').innerText = document.getElementById('cId').value || "...";
        document.getElementById('p-det').innerText = document.getElementById('det').value || "...";
        document.getElementById('p-tot').innerText = "$ " + (document.getElementById('monto').value || "0.00");
        document.getElementById('p-fec').innerText = new Date().toLocaleDateString();
    }

    async function enviar(canal) {
        const cliente = document.getElementById('cNom').value || "Cliente";
        const monto = document.getElementById('monto').value || "0";
        const pago = document.getElementById('ePago').value;
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();

        // Dise√±o PDF texto
        pdf.setFontSize(18); pdf.text("FACTURA", 105, 20, {align:'center'});
        pdf.setFontSize(12);
        pdf.text(`Emisor: ${document.getElementById('eNom').value}`, 20, 40);
        pdf.text(`Cliente: ${cliente}`, 20, 50);
        pdf.text(`Total: $${monto}`, 20, 60);
        pdf.text(`Concepto: ${document.getElementById('det').value}`, 20, 70);

        pdf.save(`Factura_${cliente}.pdf`);

        if (canal === 'mail') {
            const mail = document.getElementById('email').value;
            if(!mail) return alert("Falta email");
            const btn = document.getElementById('btnM');
            btn.innerText = "Enviando...";
            
            const base64 = pdf.output('datauristring').split(',')[1];
            
            emailjs.send("service_t5t4wor", "template_vyjg8af", {
                to_email: mail,
                to_name: cliente,
                content: base64 // <-- LA VARIABLE PARA EL ADJUNTO
            }).then(() => { alert("¬°Enviado!"); btn.innerText = "üìß Mail"; })
              .catch((err) => { alert("Error EmailJS"); console.log(err); });

        } else {
            const tel = document.getElementById('tel').value;
            if(!tel) return alert("Falta WhatsApp");
            const txt = `*NUEVA FACTURA*%0A*Cliente:* ${cliente}%0A*Total:* $${monto}%0A*CBU/Alias:* ${pago}%0A%0A_PDF descargado._`;
            window.open(`https://api.whatsapp.com/send?phone=${tel}&text=${txt}`, '_blank');
        }
    }
    window.onload = render;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturador Pro - WYSIWYG</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; --card: #ffffff; --border: #e2e8f0; }
        body.dark-mode { --bg: #0f172a; --text: #f1f5f9; --card: #1e293b; --border: #334155; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; transition: 0.3s; }
        
        .app-container { max-width: 900px; margin: 0 auto; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; margin-top: 5px; background: var(--card); color: var(--text); }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-theme { position: fixed; top: 10px; right: 10px; padding: 8px 12px; border-radius: 20px; background: var(--card); color: var(--text); cursor: pointer; border: 1px solid var(--border); }

        /* FACTURA PREVIEW ESTILO AFIP (ESTO ES LO QUE SE CONVIERTE EN PDF) */
        #factura-digital { 
            background: white; 
            color: black; 
            width: 700px; /* TamaÃ±o fijo para que el PDF no salga deforme */
            margin: 20px auto; 
            border: 2px solid #000; 
            padding: 0;
            display: block;
        }
        .f-header { display: flex; border-bottom: 2px solid #000; height: 100px; }
        .f-col { flex: 1; padding: 15px; position: relative; }
        .f-type { width: 60px; border-left: 2px solid #000; border-right: 2px solid #000; background: #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .f-type h2 { margin: 0; font-size: 2.5rem; }
        
        .f-client-info { padding: 15px; border-bottom: 2px solid #000; line-height: 1.5; font-size: 0.9rem; }
        .f-items-head { display: grid; grid-template-columns: 4fr 1fr; background: #eee; border-bottom: 1px solid #000; padding: 5px 15px; font-weight: bold; }
        .f-item-row { display: grid; grid-template-columns: 4fr 1fr; padding: 15px; min-height: 100px; }
        .f-footer { border-top: 2px solid #000; padding: 15px; text-align: right; }
        .f-total { font-size: 1.8rem; font-weight: 900; }
    </style>
</head>
<body>

<button class="btn-theme" onclick="document.body.classList.toggle('dark-mode')">ðŸŒ“ Tema</button>

<div class="app-container">
    <div class="card">
        <h3>ðŸš€ Datos de FacturaciÃ³n</h3>
        <div class="main-grid">
            <div>
                <label>Tu Empresa</label>
                <input type="text" id="eNom" value="Aero 2000" oninput="update()">
                <label>Tu CUIT</label>
                <input type="text" id="eCuit" value="30-12345678-9" oninput="update()">
            </div>
            <div>
                <label>Cliente</label>
                <input type="text" id="cNom" placeholder="Nombre Cliente" oninput="update()">
                <label>Email Cliente</label>
                <input type="email" id="email" placeholder="mail@cliente.com">
            </div>
        </div>
        <label>Concepto</label>
        <textarea id="det" oninput="update()" placeholder="Servicios prestados..."></textarea>
        <label>Monto Total $</label>
        <input type="number" id="monto" oninput="update()" placeholder="0.00">
        
        <button onclick="generarYEnviar()" class="btn-primary" id="btnGo">DESCARGAR PDF IDÃ‰NTICO</button>
    </div>

    <div id="factura-digital">
        <div class="f-header">
            <div class="f-col">
                <strong id="p-eNom">AERO 2000</strong><br>
                <span>Responsable Monotributo</span><br>
                <span>CUIT: <span id="p-eCuit">30-12345678-9</span></span>
            </div>
            <div class="f-type">
                <h2>C</h2>
                <small>COD. 011</small>
            </div>
            <div class="f-col" style="text-align: right;">
                <strong>FACTURA</strong><br>
                <span>Fecha: <span id="p-fec">--/--/--</span></span><br>
                <span>Nro: 00001-00000042</span>
            </div>
        </div>
        <div class="f-client-info">
            <strong>CLIENTE:</strong> <span id="p-cNom">...</span><br>
            <strong>IVA:</strong> Consumidor Final<br>
            <strong>CONDICIÃ“N DE VENTA:</strong> Contado
        </div>
        <div class="f-items-head">
            <span>DescripciÃ³n</span>
            <span style="text-align: right;">Importe</span>
        </div>
        <div class="f-item-row">
            <span id="p-det">...</span>
            <span style="text-align: right; font-weight: bold;" id="p-sub">$ 0.00</span>
        </div>
        <div class="f-footer">
            <span class="f-total">TOTAL: <span id="p-tot">$ 0.00</span></span>
        </div>
    </div>
</div>

<script>
    emailjs.init("ne2_1nbxGq2hC0ju1");

    function update() {
        document.getElementById('p-eNom').innerText = document.getElementById('eNom').value.toUpperCase();
        document.getElementById('p-eCuit').innerText = document.getElementById('eCuit').value;
        document.getElementById('p-cNom').innerText = document.getElementById('cNom').value.toUpperCase();
        document.getElementById('p-det').innerText = document.getElementById('det').value;
        const total = document.getElementById('monto').value || "0.00";
        document.getElementById('p-tot').innerText = "$ " + total;
        document.getElementById('p-sub').innerText = "$ " + total;
        document.getElementById('p-fec').innerText = new Date().toLocaleDateString();
    }

    async function generarYEnviar() {
        const btn = document.getElementById('btnGo');
        const element = document.getElementById('factura-digital');
        const mail = document.getElementById('email').value;

        btn.disabled = true;
        btn.innerText = "CAPTURANDO FACTURA...";

        try {
            // 1. CAPTURAR EL HTML COMO IMAGEN (Mantiene los estilos CSS exactos)
            const canvas = await html2canvas(element, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');

            // 2. CREAR PDF CON ESA IMAGEN
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 0, 10, pdfWidth, pdfHeight);

            // 3. DESCARGAR
            pdf.save(`Factura_${document.getElementById('cNom').value}.pdf`);

            // 4. ENVIAR POR EMAIL (Opcional)
            if(mail) {
                const base64 = pdf.output('datauristring').split(',')[1];
                await emailjs.send("service_t5t4wor", "template_vyjg8af", {
                    to_email: mail,
                    content: base64,
                    to_name: document.getElementById('cNom').value
                });
                alert("PDF descargado y enviado por mail.");
            }

        } catch (e) {
            alert("Error: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "DESCARGAR PDF IDÃ‰NTICO";
        }
    }

    window.onload = update;
</script>
</body>
</html>
